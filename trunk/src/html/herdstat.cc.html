<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<title>~/code/herdstat/branches/ka0ttic/src/herdstat.cc.html</title>
<meta name="Generator" content="Vim/7.0"/>
<meta http-equiv="content-type" content="text/html; charset=UTF-8"/>
<style type="text/css">
<!--
.Special { color: #c080d0; }
.Number { color: #506dbd; }
.Statement { color: #808bed; }
pre { color: #cfbfad; background-color: #1e1e27; }
body { color: #cfbfad; background-color: #1e1e27; }
.lnr { color: #8b8bcd; background-color: #1e1e27; }
.Comment { color: #cd8b00; }
.PreProc { color: #409090; }
.Constant { color: #ffcd8b; }
.Type { color: #ff8bff; }
-->
</style>
</head>
<body>
<pre>
<span class="lnr">  1 </span><span class="Comment">/*</span>
<span class="lnr">  2 </span><span class="Comment"> * herdstat -- src/herdstat.cc</span>
<span class="lnr">  3 </span><span class="Comment"> * $Id: herdstat.cc 104 2005-03-06 19:47:53Z ka0ttic $</span>
<span class="lnr">  4 </span><span class="Comment"> * Copyright (c) 2005 Aaron Walker &lt;ka0ttic at gentoo.org&gt;</span>
<span class="lnr">  5 </span><span class="Comment"> *</span>
<span class="lnr">  6 </span><span class="Comment"> * This file is part of herdstat.</span>
<span class="lnr">  7 </span><span class="Comment"> *</span>
<span class="lnr">  8 </span><span class="Comment"> * herdstat is free software; you can redistribute it and/or modify it under the</span>
<span class="lnr">  9 </span><span class="Comment"> * terms of the GNU General Public License as published by the Free Software</span>
<span class="lnr"> 10 </span><span class="Comment"> * Foundation; either version 2 of the License, or (at your option) any later</span>
<span class="lnr"> 11 </span><span class="Comment"> * version.</span>
<span class="lnr"> 12 </span><span class="Comment"> *</span>
<span class="lnr"> 13 </span><span class="Comment"> * herdstat is distributed in the hope that it will be useful, but WITHOUT ANY</span>
<span class="lnr"> 14 </span><span class="Comment"> * WARRANTY; without even the implied warranty of MERCHANTABILITY or FITNESS</span>
<span class="lnr"> 15 </span><span class="Comment"> * FOR A PARTICULAR PURPOSE.  See the GNU General Public License for more</span>
<span class="lnr"> 16 </span><span class="Comment"> * details.</span>
<span class="lnr"> 17 </span><span class="Comment"> *</span>
<span class="lnr"> 18 </span><span class="Comment"> * You should have received a copy of the GNU General Public License along with</span>
<span class="lnr"> 19 </span><span class="Comment"> * herdstat; if not, write to the Free Software Foundation, Inc., 59 Temple</span>
<span class="lnr"> 20 </span><span class="Comment"> * Place, Suite 325, Boston, MA  02111-1257  USA</span>
<span class="lnr"> 21 </span><span class="Comment"> </span><span class="Comment">*/</span>
<span class="lnr"> 22 </span>
<span class="lnr"> 23 </span><span class="PreProc">#ifdef HAVE_CONFIG_H</span>
<span class="lnr"> 24 </span><span class="PreProc"># include </span><span class="Constant">&quot;config.h&quot;</span>
<span class="lnr"> 25 </span><span class="PreProc">#endif</span>
<span class="lnr"> 26 </span>
<span class="lnr"> 27 </span><span class="PreProc">#include </span><span class="Constant">&lt;iostream&gt;</span>
<span class="lnr"> 28 </span><span class="PreProc">#include </span><span class="Constant">&lt;map&gt;</span>
<span class="lnr"> 29 </span><span class="PreProc">#include </span><span class="Constant">&lt;vector&gt;</span>
<span class="lnr"> 30 </span><span class="PreProc">#include </span><span class="Constant">&lt;algorithm&gt;</span>
<span class="lnr"> 31 </span><span class="PreProc">#include </span><span class="Constant">&lt;memory&gt;</span>
<span class="lnr"> 32 </span><span class="PreProc">#include </span><span class="Constant">&lt;cstring&gt;</span>
<span class="lnr"> 33 </span><span class="PreProc">#include </span><span class="Constant">&lt;cstdio&gt;</span>
<span class="lnr"> 34 </span><span class="PreProc">#include </span><span class="Constant">&lt;cstdlib&gt;</span>
<span class="lnr"> 35 </span><span class="PreProc">#include </span><span class="Constant">&lt;cstdarg&gt;</span>
<span class="lnr"> 36 </span><span class="PreProc">#include </span><span class="Constant">&lt;ctime&gt;</span>
<span class="lnr"> 37 </span><span class="PreProc">#include </span><span class="Constant">&lt;sys/types.h&gt;</span>
<span class="lnr"> 38 </span><span class="PreProc">#include </span><span class="Constant">&lt;sys/stat.h&gt;</span>
<span class="lnr"> 39 </span><span class="PreProc">#include </span><span class="Constant">&lt;unistd.h&gt;</span>
<span class="lnr"> 40 </span>
<span class="lnr"> 41 </span><span class="PreProc">#ifdef HAVE_GETOPT_H</span>
<span class="lnr"> 42 </span><span class="PreProc"># include </span><span class="Constant">&lt;getopt.h&gt;</span>
<span class="lnr"> 43 </span><span class="PreProc">#endif</span>
<span class="lnr"> 44 </span>
<span class="lnr"> 45 </span><span class="PreProc">#include </span><span class="Constant">&quot;herds.hh&quot;</span>
<span class="lnr"> 46 </span><span class="PreProc">#include </span><span class="Constant">&quot;formatter.hh&quot;</span>
<span class="lnr"> 47 </span><span class="PreProc">#include </span><span class="Constant">&quot;xmlparser.hh&quot;</span>
<span class="lnr"> 48 </span><span class="PreProc">#include </span><span class="Constant">&quot;options.hh&quot;</span>
<span class="lnr"> 49 </span><span class="PreProc">#include </span><span class="Constant">&quot;util.hh&quot;</span>
<span class="lnr"> 50 </span><span class="PreProc">#include </span><span class="Constant">&quot;exceptions.hh&quot;</span>
<span class="lnr"> 51 </span><span class="PreProc">#include </span><span class="Constant">&quot;herds_xml_handler.hh&quot;</span>
<span class="lnr"> 52 </span><span class="PreProc">#include </span><span class="Constant">&quot;action_herd_handler.hh&quot;</span>
<span class="lnr"> 53 </span><span class="PreProc">#include </span><span class="Constant">&quot;action_pkg_handler.hh&quot;</span>
<span class="lnr"> 54 </span><span class="PreProc">#include </span><span class="Constant">&quot;action_dev_handler.hh&quot;</span>
<span class="lnr"> 55 </span>
<span class="lnr"> 56 </span><span class="Type">static</span> <span class="Type">const</span> <span class="Type">char</span> *short_opts = <span class="Constant">&quot;H:hVvDdtpq&quot;</span>;
<span class="lnr"> 57 </span>
<span class="lnr"> 58 </span><span class="PreProc">#ifdef HAVE_GETOPT_LONG</span>
<span class="lnr"> 59 </span><span class="Type">static</span> <span class="Type">struct</span> option long_opts[] =
<span class="lnr"> 60 </span>{
<span class="lnr"> 61 </span>    {<span class="Constant">&quot;version&quot;</span>,     no_argument,        <span class="Number">0</span>,  <span class="Constant">'V'</span>},
<span class="lnr"> 62 </span>    {<span class="Constant">&quot;help&quot;</span>,        no_argument,        <span class="Number">0</span>,  <span class="Constant">'h'</span>},
<span class="lnr"> 63 </span>    {<span class="Constant">&quot;verbose&quot;</span>,     no_argument,        <span class="Number">0</span>,  <span class="Constant">'v'</span>},
<span class="lnr"> 64 </span>    {<span class="Constant">&quot;quiet&quot;</span>,       no_argument,        <span class="Number">0</span>,  <span class="Constant">'q'</span>},
<span class="lnr"> 65 </span>    {<span class="Constant">&quot;debug&quot;</span>,       no_argument,        <span class="Number">0</span>,  <span class="Constant">'D'</span>},
<span class="lnr"> 66 </span>    <span class="Comment">/*</span><span class="Comment"> time how long it takes for XML parsing </span><span class="Comment">*/</span>
<span class="lnr"> 67 </span>    {<span class="Constant">&quot;timer&quot;</span>,       no_argument,        <span class="Number">0</span>,  <span class="Constant">'t'</span>},
<span class="lnr"> 68 </span>    <span class="Comment">/*</span><span class="Comment"> instead of displaying devs for a herd, display herds for a dev </span><span class="Comment">*/</span>
<span class="lnr"> 69 </span>    {<span class="Constant">&quot;dev&quot;</span>,         no_argument,        <span class="Number">0</span>,  <span class="Constant">'d'</span>},
<span class="lnr"> 70 </span>    <span class="Comment">/*</span><span class="Comment"> specify the location of a local herds.xml </span><span class="Comment">*/</span>
<span class="lnr"> 71 </span>    {<span class="Constant">&quot;herdsxml&quot;</span>,    required_argument,  <span class="Number">0</span>,  <span class="Constant">'H'</span>},
<span class="lnr"> 72 </span>    <span class="Comment">/*</span><span class="Comment"> show package stats for the specified herds </span><span class="Comment">*/</span>
<span class="lnr"> 73 </span>    {<span class="Constant">&quot;package&quot;</span>,     no_argument,        <span class="Number">0</span>,  <span class="Constant">'p'</span>},
<span class="lnr"> 74 </span>    { <span class="Number">0</span>, <span class="Number">0</span>, <span class="Number">0</span>, <span class="Number">0</span> }
<span class="lnr"> 75 </span>};
<span class="lnr"> 76 </span><span class="PreProc">#endif</span> <span class="Comment">/*</span><span class="Comment"> HAVE_GETOPT_LONG </span><span class="Comment">*/</span>
<span class="lnr"> 77 </span>
<span class="lnr"> 78 </span><span class="Type">void</span>
<span class="lnr"> 79 </span>version()
<span class="lnr"> 80 </span>{
<span class="lnr"> 81 </span>    std::cout &lt;&lt; PACKAGE &lt;&lt; <span class="Constant">&quot;-&quot;</span> &lt;&lt; VERSION &lt;&lt; std::endl;
<span class="lnr"> 82 </span>}
<span class="lnr"> 83 </span>
<span class="lnr"> 84 </span><span class="Type">void</span>
<span class="lnr"> 85 </span>usage()
<span class="lnr"> 86 </span>{
<span class="lnr"> 87 </span>    std::cerr
<span class="lnr"> 88 </span>        &lt;&lt; <span class="Constant">&quot;usage: &quot;</span> &lt;&lt; PACKAGE &lt;&lt; <span class="Constant">&quot; [options] [args]&quot;</span> &lt;&lt; std::endl
<span class="lnr"> 89 </span>        &lt;&lt; <span class="Constant">&quot;Use --help to see more detailed usage information.&quot;</span> &lt;&lt; std::endl;
<span class="lnr"> 90 </span>}
<span class="lnr"> 91 </span>
<span class="lnr"> 92 </span><span class="Type">void</span>
<span class="lnr"> 93 </span>help()
<span class="lnr"> 94 </span>{
<span class="lnr"> 95 </span>    std::cout
<span class="lnr"> 96 </span>        &lt;&lt; <span class="Constant">&quot;usage: &quot;</span> &lt;&lt; PACKAGE &lt;&lt; <span class="Constant">&quot; [options] [args]&quot;</span> &lt;&lt; std::endl
<span class="lnr"> 97 </span>
<span class="lnr"> 98 </span><span class="PreProc">#ifdef HAVE_GETOPT_LONG</span>
<span class="lnr"> 99 </span>        &lt;&lt; <span class="Constant">&quot; -h, --help            Display this help message.&quot;</span> &lt;&lt; std::endl
<span class="lnr">100 </span>        &lt;&lt; <span class="Constant">&quot; -V, --version         Display version information.&quot;</span> &lt;&lt; std::endl
<span class="lnr">101 </span>        &lt;&lt; std::endl
<span class="lnr">102 </span>        &lt;&lt; <span class="Constant">&quot;Where [options] can be any of the following:&quot;</span> &lt;&lt; std::endl
<span class="lnr">103 </span>        &lt;&lt; <span class="Constant">&quot; -p, --package         Look up packages by herd.&quot;</span> &lt;&lt; std::endl
<span class="lnr">104 </span>        &lt;&lt; <span class="Constant">&quot; -d, --dev             Look up herds by developer.&quot;</span> &lt;&lt; std::endl
<span class="lnr">105 </span>        &lt;&lt; <span class="Constant">&quot; -H, --herdsxml &lt;file&gt; Specify location of herds.xml.&quot;</span> &lt;&lt; std::endl
<span class="lnr">106 </span>        &lt;&lt; <span class="Constant">&quot; -v, --verbose         Display verbose output.&quot;</span> &lt;&lt; std::endl
<span class="lnr">107 </span>        &lt;&lt; <span class="Constant">&quot; -q, --quiet           Don't display labels and fancy colors. Use this&quot;</span>
<span class="lnr">108 </span>        &lt;&lt; std::endl
<span class="lnr">109 </span>        &lt;&lt; <span class="Constant">&quot;                       option to pipe herdstat output to other programs&quot;</span>
<span class="lnr">110 </span>        &lt;&lt; std::endl
<span class="lnr">111 </span>        &lt;&lt; <span class="Constant">&quot; -D, --debug           Display debugging messages.&quot;</span> &lt;&lt; std::endl
<span class="lnr">112 </span>        &lt;&lt; <span class="Constant">&quot; -t, --timer           Display elapsed time of XML parsing.&quot;</span> &lt;&lt; std::endl
<span class="lnr">113 </span>        &lt;&lt; std::endl
<span class="lnr">114 </span>        &lt;&lt; <span class="Constant">&quot;Where [args] depends on the specified action:&quot;</span> &lt;&lt; std::endl
<span class="lnr">115 </span>        &lt;&lt; <span class="Constant">&quot; default action        1 or more herds.&quot;</span> &lt;&lt; std::endl
<span class="lnr">116 </span>        &lt;&lt; <span class="Constant">&quot; -p, --package         1 or more herds.&quot;</span> &lt;&lt; std::endl
<span class="lnr">117 </span>        &lt;&lt; <span class="Constant">&quot; -d, --dev             1 or more developers.&quot;</span> &lt;&lt; std::endl
<span class="lnr">118 </span>
<span class="lnr">119 </span><span class="PreProc">#else</span>
<span class="lnr">120 </span>
<span class="lnr">121 </span>        &lt;&lt; <span class="Constant">&quot; -h              Display this help message.&quot;</span> &lt;&lt; std::endl
<span class="lnr">122 </span>        &lt;&lt; <span class="Constant">&quot; -V              Display version information.&quot;</span> &lt;&lt; std::endl
<span class="lnr">123 </span>        &lt;&lt; std::endl
<span class="lnr">124 </span>        &lt;&lt; <span class="Constant">&quot;Where [options] can be any of the following:&quot;</span> &lt;&lt; std::endl
<span class="lnr">125 </span>        &lt;&lt; <span class="Constant">&quot; -p              Look up packages by herd.&quot;</span> &lt;&lt; std::endl
<span class="lnr">126 </span>        &lt;&lt; <span class="Constant">&quot; -d              Look up herds by developer.&quot;</span> &lt;&lt; std::endl
<span class="lnr">127 </span>        &lt;&lt; <span class="Constant">&quot; -H &lt;file&gt;       Specify location of herds.xml.&quot;</span> &lt;&lt; std::endl
<span class="lnr">128 </span>        &lt;&lt; <span class="Constant">&quot; -v              Display verbose output.&quot;</span> &lt;&lt; std::endl
<span class="lnr">129 </span>        &lt;&lt; <span class="Constant">&quot; -q              Don't display labels and fancy colors. Use this&quot;</span>
<span class="lnr">130 </span>        &lt;&lt; std::endl
<span class="lnr">131 </span>        &lt;&lt; <span class="Constant">&quot;                 option to pipe herdstat output to other programs&quot;</span>
<span class="lnr">132 </span>        &lt;&lt; std::endl
<span class="lnr">133 </span>        &lt;&lt; <span class="Constant">&quot; -D              Display debugging messages.&quot;</span> &lt;&lt; std::endl
<span class="lnr">134 </span>        &lt;&lt; <span class="Constant">&quot; -t              Display elapsed time of XML parsing.&quot;</span> &lt;&lt; std::endl
<span class="lnr">135 </span>        &lt;&lt; std::endl
<span class="lnr">136 </span>        &lt;&lt; <span class="Constant">&quot;Where [args] depends on the specified action:&quot;</span> &lt;&lt; std::endl
<span class="lnr">137 </span>        &lt;&lt; <span class="Constant">&quot; default action  1 or more herds.&quot;</span> &lt;&lt; std::endl
<span class="lnr">138 </span>        &lt;&lt; <span class="Constant">&quot; -p              1 or more herds.&quot;</span> &lt;&lt; std::endl
<span class="lnr">139 </span>        &lt;&lt; <span class="Constant">&quot; -d              1 or more developers.&quot;</span> &lt;&lt; std::endl
<span class="lnr">140 </span>
<span class="lnr">141 </span><span class="PreProc">#endif</span> <span class="Comment">/*</span><span class="Comment"> HAVE_GETOPT_LONG </span><span class="Comment">*/</span>
<span class="lnr">142 </span>
<span class="lnr">143 </span>        &lt;&lt; std::endl
<span class="lnr">144 </span>        &lt;&lt; PACKAGE &lt;&lt; <span class="Constant">&quot; respects the HERDS environment variable.&quot;</span> &lt;&lt; std::endl
<span class="lnr">145 </span>        &lt;&lt; <span class="Constant">&quot;Set it in your shell rcfile to permanently set the location of &quot;</span>
<span class="lnr">146 </span>        &lt;&lt; <span class="Constant">&quot;your herds.xml&quot;</span> &lt;&lt; std::endl;
<span class="lnr">147 </span>}
<span class="lnr">148 </span>
<span class="lnr">149 </span><span class="Type">int</span>
<span class="lnr">150 </span>handle_opts(<span class="Type">int</span> argc, <span class="Type">char</span> **argv, options_T *opts,
<span class="lnr">151 </span>    std::vector&lt;std::string&gt; *args)
<span class="lnr">152 </span>{
<span class="lnr">153 </span>    <span class="Type">int</span> key, opt_index = <span class="Number">0</span>;
<span class="lnr">154 </span>
<span class="lnr">155 </span>    <span class="Statement">while</span> (<span class="Constant">true</span>)
<span class="lnr">156 </span>    {
<span class="lnr">157 </span><span class="PreProc">#ifdef HAVE_GETOPT_LONG</span>
<span class="lnr">158 </span>        key = getopt_long(argc, argv, short_opts, long_opts, &amp;opt_index);
<span class="lnr">159 </span><span class="PreProc">#else</span>
<span class="lnr">160 </span>        key = getopt(argc, argv, short_opts);
<span class="lnr">161 </span><span class="PreProc">#endif</span> <span class="Comment">/*</span><span class="Comment"> HAVE_GETOPT_LONG </span><span class="Comment">*/</span>
<span class="lnr">162 </span>
<span class="lnr">163 </span>        <span class="Statement">if</span> (key == -<span class="Number">1</span>)
<span class="lnr">164 </span>            <span class="Statement">break</span>;
<span class="lnr">165 </span>
<span class="lnr">166 </span>        <span class="Statement">switch</span> (key)
<span class="lnr">167 </span>        {
<span class="lnr">168 </span>            <span class="Comment">/*</span><span class="Comment"> --dev </span><span class="Comment">*/</span>
<span class="lnr">169 </span>            <span class="Statement">case</span> <span class="Constant">'d'</span>:
<span class="lnr">170 </span>                <span class="Statement">if</span> (opts-&gt;action() != action_unspecified)
<span class="lnr">171 </span>                    <span class="Statement">throw</span> args_one_action_only_E();
<span class="lnr">172 </span>                opts-&gt;set_action(action_dev);
<span class="lnr">173 </span>                <span class="Statement">break</span>;
<span class="lnr">174 </span>            <span class="Comment">/*</span><span class="Comment"> --verbose </span><span class="Comment">*/</span>
<span class="lnr">175 </span>            <span class="Statement">case</span> <span class="Constant">'v'</span>:
<span class="lnr">176 </span>                opts-&gt;set_verbose(<span class="Constant">true</span>);
<span class="lnr">177 </span>                <span class="Statement">break</span>;
<span class="lnr">178 </span>            <span class="Comment">/*</span><span class="Comment"> --quiet </span><span class="Comment">*/</span>
<span class="lnr">179 </span>            <span class="Statement">case</span> <span class="Constant">'q'</span>:
<span class="lnr">180 </span>                opts-&gt;set_quiet(<span class="Constant">true</span>);
<span class="lnr">181 </span>                <span class="Statement">break</span>;
<span class="lnr">182 </span>            <span class="Comment">/*</span><span class="Comment"> --herdsxml </span><span class="Comment">*/</span>
<span class="lnr">183 </span>            <span class="Statement">case</span> <span class="Constant">'H'</span>:
<span class="lnr">184 </span>                opts-&gt;set_herds_xml(optarg);
<span class="lnr">185 </span>                <span class="Statement">break</span>;
<span class="lnr">186 </span>            <span class="Comment">/*</span><span class="Comment"> --debug </span><span class="Comment">*/</span>
<span class="lnr">187 </span>            <span class="Statement">case</span> <span class="Constant">'D'</span>:
<span class="lnr">188 </span>                opts-&gt;set_timer(<span class="Constant">true</span>);
<span class="lnr">189 </span>                opts-&gt;set_debug(<span class="Constant">true</span>);
<span class="lnr">190 </span>                <span class="Statement">break</span>;
<span class="lnr">191 </span>            <span class="Comment">/*</span><span class="Comment"> --timer </span><span class="Comment">*/</span>
<span class="lnr">192 </span>            <span class="Statement">case</span> <span class="Constant">'t'</span>:
<span class="lnr">193 </span>                opts-&gt;set_timer(<span class="Constant">true</span>);
<span class="lnr">194 </span>                <span class="Statement">break</span>;
<span class="lnr">195 </span>            <span class="Comment">/*</span><span class="Comment"> --package </span><span class="Comment">*/</span>
<span class="lnr">196 </span>            <span class="Statement">case</span> <span class="Constant">'p'</span>:
<span class="lnr">197 </span>                <span class="Statement">if</span> (opts-&gt;action() != action_unspecified)
<span class="lnr">198 </span>                    <span class="Statement">throw</span> args_one_action_only_E();
<span class="lnr">199 </span>                opts-&gt;set_action(action_pkg);
<span class="lnr">200 </span>                <span class="Statement">break</span>;
<span class="lnr">201 </span>            <span class="Comment">/*</span><span class="Comment"> --version </span><span class="Comment">*/</span>
<span class="lnr">202 </span>            <span class="Statement">case</span> <span class="Constant">'V'</span>:
<span class="lnr">203 </span>                <span class="Statement">throw</span> args_version_E();
<span class="lnr">204 </span>                <span class="Statement">break</span>;
<span class="lnr">205 </span>            <span class="Comment">/*</span><span class="Comment"> --help </span><span class="Comment">*/</span>
<span class="lnr">206 </span>            <span class="Statement">case</span> <span class="Constant">'h'</span>:
<span class="lnr">207 </span>                <span class="Statement">throw</span> args_help_E();
<span class="lnr">208 </span>                <span class="Statement">break</span>;
<span class="lnr">209 </span>            <span class="Statement">case</span> <span class="Number">0</span>:
<span class="lnr">210 </span>                <span class="Statement">throw</span> args_usage_E();
<span class="lnr">211 </span>                <span class="Statement">break</span>;
<span class="lnr">212 </span>            <span class="Statement">default</span>:
<span class="lnr">213 </span>                <span class="Statement">throw</span> args_E();
<span class="lnr">214 </span>                <span class="Statement">break</span>;
<span class="lnr">215 </span>        }
<span class="lnr">216 </span>    }
<span class="lnr">217 </span>
<span class="lnr">218 </span>    <span class="Statement">if</span> (optind &lt; argc)
<span class="lnr">219 </span>    {
<span class="lnr">220 </span>        <span class="Statement">while</span> (optind &lt; argc)
<span class="lnr">221 </span>            args-&gt;push_back(argv[optind++]);
<span class="lnr">222 </span>    }
<span class="lnr">223 </span>    <span class="Statement">else</span>
<span class="lnr">224 </span>        <span class="Statement">throw</span> args_usage_E();
<span class="lnr">225 </span>
<span class="lnr">226 </span>    <span class="Statement">return</span> <span class="Number">0</span>;
<span class="lnr">227 </span>}
<span class="lnr">228 </span>
<span class="lnr">229 </span><span class="Comment">/*</span><span class="Comment"> unary predicate for the remove_if() call below </span><span class="Comment">*/</span>
<span class="lnr">230 </span><span class="Type">bool</span> isNotAll(std::string &amp;s) { <span class="Statement">return</span> (s != <span class="Constant">&quot;all&quot;</span>); }
<span class="lnr">231 </span>
<span class="lnr">232 </span><span class="Type">int</span>
<span class="lnr">233 </span>main(<span class="Type">int</span> argc, <span class="Type">char</span> **argv)
<span class="lnr">234 </span>{
<span class="lnr">235 </span>    options_T options;
<span class="lnr">236 </span>    formatter_T output;
<span class="lnr">237 </span>    util::timer_T timer;
<span class="lnr">238 </span>    std::string fetched_location = util::sprintf(<span class="Constant">&quot;</span><span class="Special">%s</span><span class="Constant">/</span><span class="Special">%s</span><span class="Constant">/herds.xml&quot;</span>,
<span class="lnr">239 </span>        LOCALSTATEDIR, PACKAGE);
<span class="lnr">240 </span>
<span class="lnr">241 </span>    <span class="Comment">/*</span><span class="Comment"> try to determine current columns, otherwise use default </span><span class="Comment">*/</span>
<span class="lnr">242 </span>    std::string s = util::get_output_of(<span class="Constant">&quot;stty size 2&gt;/dev/null | cut -d' ' -f2&quot;</span>);
<span class="lnr">243 </span>    <span class="Statement">if</span> (<span class="Statement">not</span> s.empty())
<span class="lnr">244 </span>        options.set_maxcol(atoi(s.c_str()));
<span class="lnr">245 </span>
<span class="lnr">246 </span>    <span class="Statement">try</span>
<span class="lnr">247 </span>    {
<span class="lnr">248 </span>        util::color_map_T color;
<span class="lnr">249 </span>        std::vector&lt;std::string&gt; nonopt_args;
<span class="lnr">250 </span>
<span class="lnr">251 </span>        <span class="Comment">/*</span><span class="Comment"> HERDS </span><span class="Comment">*/</span>
<span class="lnr">252 </span>        <span class="Type">char</span> *result = getenv(<span class="Constant">&quot;HERDS&quot;</span>);
<span class="lnr">253 </span>        <span class="Statement">if</span> (result)
<span class="lnr">254 </span>            options.set_herds_xml(result);
<span class="lnr">255 </span>        <span class="Statement">else</span>
<span class="lnr">256 </span>        {
<span class="lnr">257 </span>            <span class="Comment">/*</span><span class="Comment"> if a fetched copy exists and is newer than 24hrs, use it.</span>
<span class="lnr">258 </span><span class="Comment">             * see the explanation below where we fetch as to why we go</span>
<span class="lnr">259 </span><span class="Comment">             * through the trouble of doing this. </span><span class="Comment">*/</span>
<span class="lnr">260 </span>            <span class="Type">struct</span> stat s;
<span class="lnr">261 </span>            <span class="Statement">if</span> ((stat(fetched_location.c_str(), &amp;s) == <span class="Number">0</span>) <span class="Statement">and</span>
<span class="lnr">262 </span>                ((time(<span class="Constant">NULL</span>) - s.st_mtime) &lt; <span class="Number">86400</span>) <span class="Statement">and</span> (s.st_size &gt; <span class="Number">0</span>))
<span class="lnr">263 </span>                options.set_herds_xml(fetched_location);
<span class="lnr">264 </span>        }
<span class="lnr">265 </span>
<span class="lnr">266 </span>        <span class="Comment">/*</span><span class="Comment"> handle command line options </span><span class="Comment">*/</span>
<span class="lnr">267 </span>        <span class="Statement">if</span> (handle_opts(argc, argv, &amp;options, &amp;nonopt_args) != <span class="Number">0</span>)
<span class="lnr">268 </span>            <span class="Statement">throw</span> args_E();
<span class="lnr">269 </span>
<span class="lnr">270 </span>        <span class="Comment">/*</span><span class="Comment"> remove duplicates; also has the nice side advantage</span>
<span class="lnr">271 </span><span class="Comment">         * of sorting the output                                </span><span class="Comment">*/</span>
<span class="lnr">272 </span>        std::sort(nonopt_args.begin(), nonopt_args.end());
<span class="lnr">273 </span>        std::vector&lt;std::string&gt;::iterator pos =
<span class="lnr">274 </span>            std::unique(nonopt_args.begin(), nonopt_args.end());
<span class="lnr">275 </span>        <span class="Statement">if</span> (pos != nonopt_args.end())
<span class="lnr">276 </span>            nonopt_args.erase(pos);
<span class="lnr">277 </span>
<span class="lnr">278 </span>        <span class="Comment">/*</span><span class="Comment"> did the user specify the all target? </span><span class="Comment">*/</span>
<span class="lnr">279 </span>        pos = std::find(nonopt_args.begin(), nonopt_args.end(), <span class="Constant">&quot;all&quot;</span>);
<span class="lnr">280 </span>        <span class="Statement">if</span> (pos != nonopt_args.end())
<span class="lnr">281 </span>        {
<span class="lnr">282 </span>            <span class="Comment">/*</span><span class="Comment"> yep, so remove everything but it </span><span class="Comment">*/</span>
<span class="lnr">283 </span>            pos = std::remove_if(nonopt_args.begin(), nonopt_args.end(),
<span class="lnr">284 </span>                isNotAll);
<span class="lnr">285 </span>            <span class="Statement">if</span> (pos != nonopt_args.end())
<span class="lnr">286 </span>                nonopt_args.erase(pos);
<span class="lnr">287 </span>        }
<span class="lnr">288 </span>
<span class="lnr">289 </span>        <span class="Comment">/*</span><span class="Comment"> every action handler needs to parse herds.xml for one reason</span>
<span class="lnr">290 </span><span class="Comment">         * or another, so let's get it over with. </span><span class="Comment">*/</span>
<span class="lnr">291 </span>        std::auto_ptr&lt;HerdsXMLHandler_T&gt; handler(<span class="Statement">new</span> HerdsXMLHandler_T());
<span class="lnr">292 </span>        <span class="Statement">try</span>
<span class="lnr">293 </span>        {
<span class="lnr">294 </span>            <span class="Comment">/*</span><span class="Comment"> NOTE: ideally we'd love to only fetch it when the timestamp and</span>
<span class="lnr">295 </span><span class="Comment">             * size are different, however, because the default location to</span>
<span class="lnr">296 </span><span class="Comment">             * download herds.xml is from ViewCVS, there is no Last-Modified</span>
<span class="lnr">297 </span><span class="Comment">             * header, meaning wget can't do timestamps :(</span>
<span class="lnr">298 </span><span class="Comment">             </span><span class="Comment">*/</span>
<span class="lnr">299 </span>
<span class="lnr">300 </span>            <span class="Comment">/*</span><span class="Comment"> fetch herds.xml? </span><span class="Comment">*/</span>
<span class="lnr">301 </span>            <span class="Statement">if</span> (options.herds_xml().find(<span class="Constant">&quot;://&quot;</span>) != std::string::npos)
<span class="lnr">302 </span>            {
<span class="lnr">303 </span>                <span class="Statement">if</span> (<span class="Statement">not</span> options.quiet())
<span class="lnr">304 </span>                {
<span class="lnr">305 </span>                    std::cout
<span class="lnr">306 </span>                        &lt;&lt; <span class="Constant">&quot;Fetching herds.xml... (you can use a local &quot;</span>
<span class="lnr">307 </span>                        &lt;&lt; <span class="Constant">&quot;copy by setting the HERDS variable)&quot;</span>
<span class="lnr">308 </span>                        &lt;&lt; std::endl &lt;&lt; std::endl;
<span class="lnr">309 </span>                }
<span class="lnr">310 </span>
<span class="lnr">311 </span>                <span class="Comment">/*</span><span class="Comment"> fetch it </span><span class="Comment">*/</span>
<span class="lnr">312 </span>                <span class="Statement">if</span> (util::fetch(options.herds_xml(), fetched_location) != <span class="Number">0</span>)
<span class="lnr">313 </span>                    <span class="Statement">throw</span> fetch_E();
<span class="lnr">314 </span>
<span class="lnr">315 </span>                <span class="Comment">/*</span><span class="Comment"> instead of wget failing if it can fetch it, it'll write a</span>
<span class="lnr">316 </span><span class="Comment">                 * 0-byte file... make sure the file is greater than 0 bytes </span><span class="Comment">*/</span>
<span class="lnr">317 </span>                <span class="Type">struct</span> stat s;
<span class="lnr">318 </span>                <span class="Statement">if</span> ((stat(fetched_location.c_str(), &amp;s) == <span class="Number">0</span>) <span class="Statement">and</span>
<span class="lnr">319 </span>                    (s.st_size &gt; <span class="Number">0</span>))
<span class="lnr">320 </span>                    options.set_herds_xml(fetched_location);
<span class="lnr">321 </span>                <span class="Statement">else</span>
<span class="lnr">322 </span>                    <span class="Statement">throw</span> fetch_E();
<span class="lnr">323 </span>            }
<span class="lnr">324 </span>
<span class="lnr">325 </span>            <span class="Statement">if</span> (options.timer())
<span class="lnr">326 </span>                timer.start();
<span class="lnr">327 </span>
<span class="lnr">328 </span>            <span class="Comment">/*</span><span class="Comment"> parse herds.xml </span><span class="Comment">*/</span>
<span class="lnr">329 </span>            XMLParser_T parser(&amp;(*handler));
<span class="lnr">330 </span>            parser.parse(options.herds_xml());
<span class="lnr">331 </span>
<span class="lnr">332 </span>            <span class="Statement">if</span> (options.timer())
<span class="lnr">333 </span>                timer.stop();
<span class="lnr">334 </span>        }
<span class="lnr">335 </span>        <span class="Statement">catch</span> (<span class="Type">const</span> fetch_E)
<span class="lnr">336 </span>        {
<span class="lnr">337 </span>            std::cerr &lt;&lt; <span class="Constant">&quot;Error fetching &quot;</span> &lt;&lt; options.herds_xml()
<span class="lnr">338 </span>                &lt;&lt; std::endl &lt;&lt; std::endl
<span class="lnr">339 </span>                &lt;&lt; <span class="Constant">&quot;If you have a local copy, specify it using -H or by &quot;</span>
<span class="lnr">340 </span>                &lt;&lt; std::endl &lt;&lt; <span class="Constant">&quot;setting the HERDS environment variable.&quot;</span>
<span class="lnr">341 </span>                &lt;&lt; std::endl;
<span class="lnr">342 </span>            <span class="Statement">return</span> <span class="Constant">EXIT_FAILURE</span>;
<span class="lnr">343 </span>        }
<span class="lnr">344 </span>        <span class="Statement">catch</span> (<span class="Type">const</span> XMLParser_E &amp;e)
<span class="lnr">345 </span>        {
<span class="lnr">346 </span>            std::cerr &lt;&lt; <span class="Constant">&quot;Error parsing '&quot;</span> &lt;&lt; e.file() &lt;&lt; <span class="Constant">&quot;': &quot;</span>        &lt;&lt; e.error()
<span class="lnr">347 </span>                &lt;&lt; std::endl;
<span class="lnr">348 </span>            <span class="Statement">return</span> <span class="Constant">EXIT_FAILURE</span>;
<span class="lnr">349 </span>        }
<span class="lnr">350 </span>
<span class="lnr">351 </span>        <span class="Comment">/*</span><span class="Comment"> set default action </span><span class="Comment">*/</span>
<span class="lnr">352 </span>        <span class="Statement">if</span> (options.action() == action_unspecified)
<span class="lnr">353 </span>            options.set_action(action_herd);
<span class="lnr">354 </span>
<span class="lnr">355 </span>        std::map&lt;options_action_T, action_handler_T * &gt; handlers;
<span class="lnr">356 </span>        handlers.insert(std::make_pair(action_herd,
<span class="lnr">357 </span>            <span class="Statement">new</span> action_herd_handler_T()));
<span class="lnr">358 </span>        handlers.insert(std::make_pair(action_pkg,
<span class="lnr">359 </span>            <span class="Statement">new</span> action_pkg_handler_T()));
<span class="lnr">360 </span>        handlers.insert(std::make_pair(action_dev,
<span class="lnr">361 </span>            <span class="Statement">new</span> action_dev_handler_T()));
<span class="lnr">362 </span>
<span class="lnr">363 </span>        action_handler_T *action_handler = handlers[options.action()];
<span class="lnr">364 </span>        <span class="Statement">if</span> (action_handler)
<span class="lnr">365 </span>        {
<span class="lnr">366 </span>            <span class="Statement">try</span>
<span class="lnr">367 </span>            {
<span class="lnr">368 </span>                <span class="Statement">if</span> ((*action_handler)(handler-&gt;herds, nonopt_args) != <span class="Constant">EXIT_SUCCESS</span>)
<span class="lnr">369 </span>                    <span class="Statement">return</span> <span class="Constant">EXIT_FAILURE</span>;
<span class="lnr">370 </span>            }
<span class="lnr">371 </span>            <span class="Statement">catch</span> (action_E)
<span class="lnr">372 </span>            {
<span class="lnr">373 </span>                <span class="Statement">return</span> <span class="Constant">EXIT_FAILURE</span>;
<span class="lnr">374 </span>            }
<span class="lnr">375 </span>        }
<span class="lnr">376 </span>        <span class="Statement">else</span>
<span class="lnr">377 </span>            <span class="Statement">throw</span> args_unimplemented_E();
<span class="lnr">378 </span>
<span class="lnr">379 </span>        <span class="Statement">if</span> (options.timer())
<span class="lnr">380 </span>            <span class="Statement">throw</span> timer_E();
<span class="lnr">381 </span>    }
<span class="lnr">382 </span>    <span class="Statement">catch</span> (<span class="Type">const</span> bad_fileobject_E &amp;e)
<span class="lnr">383 </span>    {
<span class="lnr">384 </span>        std::cout &lt;&lt; e.what() &lt;&lt; std::endl;
<span class="lnr">385 </span>        <span class="Statement">return</span> <span class="Constant">EXIT_FAILURE</span>;
<span class="lnr">386 </span>    }
<span class="lnr">387 </span>    <span class="Statement">catch</span> (<span class="Type">const</span> timer_E)
<span class="lnr">388 </span>    {
<span class="lnr">389 </span>        std::cout
<span class="lnr">390 </span>            &lt;&lt; <span class="Constant">&quot;Took &quot;</span> &lt;&lt; timer.elapsed() &lt;&lt; <span class="Constant">&quot;ms to parse herds.xml.&quot;</span> &lt;&lt; std::endl;
<span class="lnr">391 </span>    }
<span class="lnr">392 </span>    <span class="Statement">catch</span> (<span class="Type">const</span> args_help_E)
<span class="lnr">393 </span>    {
<span class="lnr">394 </span>        help();
<span class="lnr">395 </span>        <span class="Statement">return</span> <span class="Constant">EXIT_SUCCESS</span>;
<span class="lnr">396 </span>    }
<span class="lnr">397 </span>    <span class="Statement">catch</span> (<span class="Type">const</span> args_version_E)
<span class="lnr">398 </span>    {
<span class="lnr">399 </span>        version();
<span class="lnr">400 </span>        <span class="Statement">return</span> <span class="Constant">EXIT_SUCCESS</span>;
<span class="lnr">401 </span>    }
<span class="lnr">402 </span>    <span class="Statement">catch</span> (<span class="Type">const</span> args_usage_E)
<span class="lnr">403 </span>    {
<span class="lnr">404 </span>        usage();
<span class="lnr">405 </span>        <span class="Statement">return</span> <span class="Constant">EXIT_FAILURE</span>;
<span class="lnr">406 </span>    }
<span class="lnr">407 </span>    <span class="Statement">catch</span> (<span class="Type">const</span> args_E)
<span class="lnr">408 </span>    {
<span class="lnr">409 </span>        usage();
<span class="lnr">410 </span>        <span class="Statement">return</span> <span class="Constant">EXIT_FAILURE</span>;
<span class="lnr">411 </span>    }
<span class="lnr">412 </span>    <span class="Statement">catch</span> (<span class="Type">const</span> herdstat_base_E &amp;e)
<span class="lnr">413 </span>    {
<span class="lnr">414 </span>        std::cerr &lt;&lt; <span class="Constant">&quot;Unhandled exception: &quot;</span> &lt;&lt; e.what() &lt;&lt; std::endl;
<span class="lnr">415 </span>        <span class="Statement">return</span> <span class="Constant">EXIT_FAILURE</span>;
<span class="lnr">416 </span>    }
<span class="lnr">417 </span>
<span class="lnr">418 </span>    <span class="Statement">return</span> <span class="Constant">EXIT_SUCCESS</span>;
<span class="lnr">419 </span>}
</pre>
</body>
</html>
